---
title: PHP版本遇到的NAN问题
date: 2019-02-20 21:20:00
categories:
- 技术
tags:
- PHP
- 问题
mermaid: true
---

### 问题简单描述

PHP7.0.* 中不同版本floatval函数对字符串 NAN 的处理结果不同。例如`var_dump(floatval('NAN')`在PHP7.0.6中返回 `float(NaN)`，在PHP7.0.33中返回 `float(0)`

### 发现过程

在最近的一个功能中，数据源返回的某个字段会出现 字符串NaN的情况。在开发时没有过多关注，就用floatval函数将其转为浮点数。在预发布环境却出现了问题--整个接口没有任何返回（忘记当时接口是否返回了500）。最终定位到，floatval在转换字符串 NaN 时，开发环境与预发布环境处理的结果不同，引起了json序列化时的错误（所以，当初返回的状态码应该是 500）。

### 延展

开发环境的版本是7.1.*，预发布是7.0.6，所以就查阅了一下php70-71的change log，但是没有查到哪里有对这个变化的说明。又试了一下php5.6版本，返回的数据与php7.1一致。又开始查阅56-70的change log，也没有查到变化的文档说明。为了寻求心理安慰，在docker上编译安装php7.0.10， php7.0.33（docker镜像中已经自动安装php7.0.6），分别运行。最终得到，php在升级7.0时，调整了floatval函数对字符串NaN的处理结果（stack overfolw上有大神在回帖中提及），而在php7.0.\* 的版本迭代中，又将floatval对NaN的处理变更回来（从结果上看）

### 总结

- **一定要保持环境一致**
- 在定位问题的时候，由于有预发布环境修改权限，并且预发布暂时无人使用，就直接在预发布修改了代码，但是这种做法很不好
- 在进行结果对比时，不清楚brew安装的命令参数是否会影响处理结果，也从另一个方面反映出自己对编译时的参数作用太不了解
- 后续要看一下不同版本的源码，看看是哪里发生了变化


